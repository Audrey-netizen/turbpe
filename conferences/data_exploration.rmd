Working directory info: IMPORTANT NOTE, keep this directory listing identical
to minimize wd errors between devices working on the same repository
  Yes that means please create a folder called "repos"
```{r}
setwd("~/Documents/repos/turbpe")
```

Packages list, plus Audrey's versions of each package
  I didn't make it mandatory to download a specific version of each package as I
  don't want anyone to make redundant downloads, just commented what I'm using
  FYI Andrew we should pretty much always be using the same versions of packages
  since we're both on macbook M4 silicone chips, so this should never be
  something to worry about for you
```{r}
library(dplyr) #V1.1.4
library(ggplot2) #V4.0.0
library(lavaan) #V0.6-20
library(piecewiseSEM) #V2.3.1
library(readr) #V2.1.5
#apparently this is faster than read.csv? Will try it, hopefully nothing breaks
library(scales) #V1.4.0
library(tidyverse) #V2.0.0
library(vegan) #V2.7-1

```

Loading up the csv files + assigning them variables
```{r}
abiotics <- read_csv("~/Documents/repos/turbpe/spreadsheets/abiotics.csv")
flowers <- read_csv("~/Documents/repos/turbpe/spreadsheets/flowers.csv")
plant_IDs <- read_csv("~/Documents/repos/turbpe/spreadsheets/Plant_ID_list.csv")
soil_data <- read_csv("~/Documents/repos/turbpe/spreadsheets/soil.csv")
road_widths <- read_csv("~/Documents/repos/turbpe/spreadsheets/road_widths.csv")

#for bee captures we need to further filter it to only include the 8 replicates
#being used for conference presentations (thanks Andrew :3)
bee_captures_8th <- read_csv("~/Documents/repos/turbpe/spreadsheets/bee_captures.csv") %>%
  filter(Replicate >= 1 & Replicate <= 8)
```

Just for my own viewing purposes here, makes rest easier
```{r}
names(bee_captures_8th)
names(abiotics)
names(flowers)
names(plant_IDs)
names(road_widths)
```

What the heck is a glipmse
```{r}
glimpse(abiotics)
glimpse(flowers)
glimpse(plant_IDs)
glimpse(road_widths)
# No really, I tried using this function now, it's giving nothing. I would
# rather just directly look at the csv files...
```

Basic summaries of bees we caught, starting with family
```{r}
family_summary <- bee_captures_8th %>%
  count(Family, name = "Count") %>%
  arrange(desc(Count))

print(family_summary)

genus_summary <- bee_captures_8th %>%
  count(Genus, name = "Count") %>%
  arrange(desc(Count))

print(genus_summary)

# No surprises, this upcoming one is gonna be very skewed to a certain species,
# since we know exactly what species it is as soon as we see an Apis... and we
# see a lot of Apis. Functionally useless bit of code rn but it's fun
species_summary <- bee_captures_8th %>%
  count(Species, name = "Count") %>%
  arrange(desc(Count))

print(species_summary)
```

Figure for this summary, will stick with just genus for now
```{r}

# This bit is redundant but I think it helps with clarity!
genus_summary <- bee_captures_8th %>%
  count(Genus, name = "Count") %>%
  arrange(desc(Count))

# Bar plot
# theme_minimal wow so cool, why doesn't everyone use this?
    # UI designers ranting about people being upset at them simplifying
    # in a nutshell hehe
ggplot(genus_summary, aes(x = reorder(Genus, -Count), y = Count, fill = Genus)) +
  geom_bar(stat = "identity") +
  scale_fill_viridis_d() +  # Colourblind-friendly <3
  labs(
    title = "Bee Genera Captured",
    x = "Genus",
    y = "Number of Captures"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
    axis.text.y = element_text(size = 10),
    axis.title = element_text(size = 12, face = "bold"),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    legend.position = "none",  # Legend would be bloat
    plot.margin = margin(1, 1, 1, 1.5, "cm"),  # Slight margins change
    panel.grid.major.x = element_blank()  # No grids plz
  ) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1)))
```

Repeat this but across four months
```{r}
# This is the important part, actually sorts out the month categories I desire
# for visibility purposes
months <- c("05", "06", "07", "08")
month_names <- c("May", "June", "July", "August")

# Ok this is an important part too... this for loop simultaneously is what sorts
# through the above months sections made and also makes it so all four figures
# are output in quick succession without copy pasting this four times :)
for (i in 1:length(months)) {
  month_data <- bee_captures_8th %>%
    filter(str_detect(Date, paste0("-", months[i], "-"))) %>%
    count(Genus, name = "Count") %>%
    arrange(desc(Count))
  
  p <- ggplot(month_data, aes(x = reorder(Genus, -Count), y = Count, fill = Genus)) +
    geom_bar(stat = "identity") +
    scale_fill_viridis_d() +
    labs(
      title = paste("Bee Genera Captured -", month_names[i]),
      x = "Genus",
      y = "Number of Captures"
    ) +
    theme_minimal() +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
      axis.text.y = element_text(size = 10),
      axis.title = element_text(size = 12, face = "bold"),
      plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
      legend.position = "none",
      plot.margin = margin(1, 1, 1, 1.5, "cm"),
      panel.grid.major.x = element_blank()
    ) +
    scale_y_continuous(expand = expansion(mult = c(0, 0.1)))
  
  print(p)
}
# Now that we're using a for loop we actually are assigning this production of
# the plot a variable
```

I wonder if converting to log scales will give anything of value, likely not
worth it with the monthly ones as the data is limited... eh it's probably worth
it but I can't be bothered for now
```{r}
genus_summary <- bee_captures_8th %>%
  count(Genus, name = "Count") %>%
  arrange(desc(Count))

# Honestly I'm still trying to figure out why these two lines of code are here,
# for now they serve the purpose of assigning a variable we proceed to use and
# setting up our log10 with count of +1 scale/format, but ehhhh I feel like this
# can be written more efficiently, I'm just not good enough for it atm
genus_summary_log <- genus_summary %>%
  mutate(LogCount = log10(Count + 1))

# Make the plot
ggplot(genus_summary_log, aes(x = reorder(Genus, -Count), y = LogCount, fill = Genus)) +
  geom_bar(stat = "identity") +
  scale_fill_viridis_d() +  # Colourblind-friendly <3
  labs(
    title = "Bee Genera Captured (Log Scale)",
    x = "Genus",
    y = "Log10(Count + 1)"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
    axis.text.y = element_text(size = 10),
    axis.title = element_text(size = 12, face = "bold"),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    legend.position = "none",  # Legend would be bloat
    plot.margin = margin(1, 1, 1, 1.5, "cm"),  # Slight margins change
    panel.grid.major.x = element_blank()  # No grids plz
  ) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1)))
```

Baseline for organizing plant data
```{r}

flowers <- read_csv("~/Documents/repos/turbpe/spreadsheets/flowers.csv")
plant_IDs <- read_csv("~/Documents/repos/turbpe/spreadsheets/Plant_ID_list.csv")
# I believe this is functionally useless, so may be removed later, but for now I
# think it helps remind readers which datasets we are working with coming up
```

```{r}
# Removing potential duplicates...this is such a flop. I shouldn't have any as
# of now in this RMD document but this is probably a good thing to do when
# you're chucking a bunch of lines of code for making figures?
plant_IDs <- plant_IDs[!duplicated(plant_IDs$ID), ]

# Create a proper taxonomic name column in plant_id_list
plant_IDs$Taxonomic_Name <- ifelse(
  !is.na(plant_IDs$Genus) & plant_IDs$Genus != "" & 
  !is.na(plant_IDs$Species) & plant_IDs$Species != "",
  paste(plant_IDs$Genus, plant_IDs$Species),
  as.character(plant_IDs$ID)  # Keep ID as character if no taxonomic name
)
```

```{r}
# Remove any duplicate rows from plant_id_list to avoid merge issues
plant_IDs <- plant_IDs[!duplicated(plant_IDs$ID), ]

# Create a proper taxonomic name column in plant_IDs
plant_IDs$Taxonomic_Name <- ifelse(
  !is.na(plant_IDs$Genus) & plant_IDs$Genus != "" & 
  !is.na(plant_IDs$Species) & plant_IDs$Species != "",
  paste(plant_IDs$Genus, plant_IDs$Species),
  as.character(plant_IDs$ID)  # Keep ID as character if no taxonomic name
)
```

```{r}
# Merging flowers data with taxonomic names
flowers_with_taxonomy <- merge(
  flowers,
  plant_IDs[, c("ID", "Taxonomic_Name")],
  by.x = "Species ID",  
  by.y = "ID",
  all.x = TRUE
)

# For Species IDs that didn't match, keeping original ID
flowers_with_taxonomy$Taxonomic_Name <- ifelse(
  is.na(flowers_with_taxonomy$Taxonomic_Name),
  as.character(flowers_with_taxonomy$`Species ID`),
  flowers_with_taxonomy$Taxonomic_Name
)
```

Most frequent flowering plants observed across all sites... to a certain amount
anyways, we still need this thing to be yknow eyeball friendly
```{r}
# Oh boy time to call/create a variable again
# this is important to set up the actual quantities that we observe each unique
# species for the following bits of code
observation_counts <- flowers_with_taxonomy %>%
  count(Taxonomic_Name, name = "Observation_Count") %>%
  arrange(desc(Observation_Count))

# Go to top 20 because top 100 is kinda hard to read/look at
top_species <- observation_counts %>%
  top_n(20, Observation_Count) %>%
  arrange(desc(Observation_Count))

# Making the plot, same colourblind-friendly style as last time
ggplot(top_species, aes(x = reorder(Taxonomic_Name, Observation_Count), 
                        y = Observation_Count, 
                        fill = Taxonomic_Name)) +
  geom_bar(stat = "identity") +
  scale_fill_viridis_d() +  # Colourblind-friendly <3
  coord_flip() +
  labs(
    title = "Top 20 Most Frequently Observed Plant Species
    (All Sites)",
    x = "Plant Species", 
    y = "Number of Observations"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 10),
    axis.text.y = element_text(size = 10),
    axis.title = element_text(size = 12, face = "bold"),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    legend.position = "none",  # Legend would be bloat
    plot.margin = margin(1, 1, 1, 1.5, "cm"),
    panel.grid.major.y = element_blank()  # No horizontal grids plz
  ) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1)))
```

Do the same but sorted for treatment, positive and negative control
```{r}
# Making different categories from the second letter of the "Site" column
flowers_with_taxonomy <- flowers_with_taxonomy %>%
  mutate(Treatment_Type = case_when(
    grepl("^.[Tt]", Site) ~ "Treatment",
    grepl("^.[Nn]", Site) ~ "Negative Control", 
    grepl("^.[Pp]", Site) ~ "Positive Control",
    TRUE ~ "Other"
  ))

# Calling observation variables again to cause less repetitive code
observation_counts_by_treatment <- flowers_with_taxonomy %>%
  count(Treatment_Type, Taxonomic_Name, name = "Observation_Count") %>%
  arrange(Treatment_Type, desc(Observation_Count))

# Top 20 species for each treatment type
top_species_by_treatment <- observation_counts_by_treatment %>%
  group_by(Treatment_Type) %>%
  top_n(20, Observation_Count) %>%
  arrange(Treatment_Type, desc(Observation_Count)) %>%
  ungroup()

# Create a function to make the plot for each treatment type
create_treatment_plot <- function(treatment_data, treatment_name) {
  ggplot(treatment_data, aes(x = reorder(Taxonomic_Name, Observation_Count), 
                            y = Observation_Count, 
                            fill = Taxonomic_Name)) +
    geom_bar(stat = "identity") +
    scale_fill_viridis_d() +
    coord_flip() +
    labs(
      title = paste("Top 20 Species -", treatment_name),
      x = "Plant Species", 
      y = "Number of Observations"
    ) +
    theme_minimal() +
    theme(
      axis.text.x = element_text(size = 10),
      axis.text.y = element_text(size = 10),
      axis.title = element_text(size = 12, face = "bold"),
      plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
      legend.position = "none",
      plot.margin = margin(1, 1, 1, 1.5, "cm"),
      panel.grid.major.y = element_blank()
    ) +
    scale_y_continuous(expand = expansion(mult = c(0, 0.1)))
}

# Plots for each treatment type
treatment_plots <- list()

treatment_plots$treatment <- create_treatment_plot(
  top_species_by_treatment %>% filter(Treatment_Type == "Treatment"),
  "Treatment"
)

treatment_plots$negative <- create_treatment_plot(
  top_species_by_treatment %>% filter(Treatment_Type == "Negative Control"),
  "Negative Control"
)

treatment_plots$positive <- create_treatment_plot(
  top_species_by_treatment %>% filter(Treatment_Type == "Positive Control"),
  "Positive Control"
)

treatment_plots$treatment
treatment_plots$negative  
treatment_plots$positive
```

I think there is a good reason to log transform some data here, the treatment
and positive control seem to have more similar distributions of plant species
```{r}
# log10 version of the plotting function
create_treatment_plot_log <- function(treatment_data, treatment_name) {
  ggplot(treatment_data, aes(x = reorder(Taxonomic_Name, Observation_Count), 
                            y = Observation_Count + 1,
                            fill = Taxonomic_Name)) +
    geom_bar(stat = "identity") +
    scale_fill_viridis_d() +
    scale_y_log10() +  
    coord_flip() +
    labs(
      title = paste("Top 20 Species -", treatment_name, "(Log10 Scale)"),
      x = "Plant Species", 
      y = "Number of Observations + 1 (Log10)"
    ) +
    theme_minimal() +
    theme(
      axis.text.x = element_text(size = 10),
      axis.text.y = element_text(size = 10),
      axis.title = element_text(size = 12, face = "bold"),
      plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
      legend.position = "none",
      plot.margin = margin(1, 1, 1, 1.5, "cm"),
      panel.grid.major.y = element_blank()
    )
}

# log10 plots for Treatment and Positive Control
log_treatment_plot <- create_treatment_plot_log(
  top_species_by_treatment %>% filter(Treatment_Type == "Treatment"),
  "Treatment"
)

log_positive_plot <- create_treatment_plot_log(
  top_species_by_treatment %>% filter(Treatment_Type == "Positive Control"),
  "Positive Control"
)

log_treatment_plot
log_positive_plot
```

Trying to get something out of these log distributions... I was taught
permanova across like 3 different ecology classes and in Eryn's biostats course
so it must be useful for something, right?
```{r}
#I'm going to be honest I still kinda have no idea how this matrix stuff works
# TwT, or maybe I do conceptually but whenever I try to think about it more it
# gets blurry
comm_matrix_sites <- flowers_with_taxonomy %>%
  filter(Treatment_Type %in% c("Treatment", "Positive Control")) %>%
  count(Site, Taxonomic_Name, name = "Count") %>%
  pivot_wider(names_from = Taxonomic_Name, values_from = Count, values_fill = 0) %>%
  column_to_rownames("Site") %>%
  as.matrix()

# Make treatment groups variable to use for actually doing the permanova 
treatment_groups <- flowers_with_taxonomy %>%
  filter(Treatment_Type %in% c("Treatment", "Positive Control")) %>%
  distinct(Site, Treatment_Type) %>%
  arrange(Site) %>%
  pull(Treatment_Type)

# The thing
permanova_result <- adonis2(comm_matrix_sites ~ treatment_groups, 
                           method = "bray",
                           permutations = 999)  # Increase permutations for better p-value

print(permanova_result)
```

Permanova for treatment vs negative just to really rub it in (or uh, be
scientifically principled, whatever that means)
```{r}

# Have to add this bit in before basically just copy paste since I am bringing
# in the negative control data in a new context
site_counts_neg_treat <- flowers_with_taxonomy %>%
  filter(Treatment_Type %in% c("Treatment", "Negative Control")) %>%
  distinct(Site, Treatment_Type) %>%
  count(Treatment_Type)

print(site_counts_neg_treat)

comm_matrix_neg_treat <- flowers_with_taxonomy %>%
  filter(Treatment_Type %in% c("Treatment", "Negative Control")) %>%
  count(Site, Taxonomic_Name, name = "Count") %>%
  pivot_wider(names_from = Taxonomic_Name, values_from = Count, values_fill = 0) %>%
  column_to_rownames("Site") %>%
  as.matrix()

treatment_groups_neg_treat <- flowers_with_taxonomy %>%
  filter(Treatment_Type %in% c("Treatment", "Negative Control")) %>%
  distinct(Site, Treatment_Type) %>%
  arrange(Site) %>%
  pull(Treatment_Type)

permanova_neg_treat <- adonis2(comm_matrix_neg_treat ~ treatment_groups_neg_treat, 
                              method = "bray",
                              permutations = 999)

print(permanova_neg_treat)
```


```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

